<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Puter Claude Chat â€“ Streaming & Copy (Final)</title>

<!-- Puter AI SDK -->
<script src="https://js.puter.com/v2/"></script>

<!-- Markdown + Syntax Highlight -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

<style>
    body {
        font-family: "Segoe UI", sans-serif;
        background-color: #0d1117;
        color: #e6edf3;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    h1 {
        text-align: center;
        color: #00bcd4;
        margin: 1rem 0;
    }
    #chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-width: 900px;
        margin: 0 auto;
    }
    .message {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 10px;
        padding: 1rem;
        max-width: 90%;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        animation: fadeIn 0.3s ease;
    }
    .ai {
        align-self: flex-start;
        border-left: 4px solid #00bcd4;
    }
    .user {
        align-self: flex-end;
        background: #1e2329;
        border-left: 4px solid #2ea043;
    }
    #input-area {
        display: flex;
        gap: 0.5rem;
        padding: 1rem;
        background: #161b22;
        border-top: 1px solid #30363d;
    }
    textarea {
        flex: 1;
        resize: none;
        border: 1px solid #30363d;
        border-radius: 8px;
        background: #0d1117;
        color: #e6edf3;
        padding: 0.7rem;
        font-size: 1rem;
        height: 60px;
    }
    button {
        background: #00bcd4;
        color: #000;
        border: none;
        border-radius: 8px;
        padding: 0 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
    }
    button:hover {
        background: #0097a7;
    }
    pre {
        background: #0d1117;
        border: 1px solid #30363d;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        position: relative;
        margin-top: 1rem;
    }
    .copy-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #2ea043;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 0.8rem;
        display: none;
    }
    pre:hover .copy-btn {
        display: block;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
</head>
<body>

<h1>Claude AI via Puter.js</h1>

<div id="chat-container"></div>

<div id="input-area">
    <textarea id="user-input" placeholder="Type your question... (Press Enter to send)"></textarea>
    <button id="send-btn">Send</button>
</div>

<script>
const chatContainer = document.getElementById('chat-container');
const sendBtn = document.getElementById('send-btn');
const userInput = document.getElementById('user-input');

// Render markdown and attach copy buttons
function renderMarkdownToHTML(text) {
    const html = marked.parse(text);
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;

    tempDiv.querySelectorAll('pre code').forEach(block => {
        hljs.highlightElement(block);
        const pre = block.parentElement;

        if (!pre.querySelector('.copy-btn')) {
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(block.textContent);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => (copyBtn.textContent = 'Copy'), 1500);
            });
            pre.appendChild(copyBtn);
        }
    });

    return tempDiv.innerHTML;
}

function addMessage(content, sender) {
    const message = document.createElement('div');
    message.classList.add('message', sender);
    message.innerHTML = renderMarkdownToHTML(content);
    chatContainer.appendChild(message);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    return message;
}

async function sendMessage() {
    const query = userInput.value.trim();
    if (!query) return;

    addMessage(query, 'user');
    userInput.value = '';

    const aiMessage = addMessage("<em>Thinking...</em>", 'ai');

    try {
        const stream = await puter.ai.chat(query, { model: 'claude-opus-4', stream: true });
        let fullText = '';
        for await (const part of stream) {
            if (part?.text) {
                fullText += part.text;
                aiMessage.innerHTML = renderMarkdownToHTML(fullText);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
    } catch (err) {
        aiMessage.innerHTML = `<span style="color:red;">Error: ${err.message}</span>`;
    }
}

// Enter key = stream send
userInput.addEventListener('keypress', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Button click also works
sendBtn.addEventListener('click', sendMessage);
</script>

</body>
</html>
